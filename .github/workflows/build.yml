name: Build CEF

on:
  workflow_dispatch:
    inputs:
      cef_version:
        description: 'CEF version (leave empty for latest stable)'
        required: false
        default: ''

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download CEF
        run: python scripts/download_cef.py --platform windows64 --output-dir cef_download

      - name: Get CEF version and shorten path
        id: cef
        shell: bash
        run: |
          CEF_VERSION=$(cat cef_download/CEF_VERSION)
          # Rename to short path to avoid Windows path length issues
          CEF_DIR=$(ls -d cef_download/cef_binary_* | head -1)
          mv "$CEF_DIR" cef
          echo "dir=cef" >> "$GITHUB_OUTPUT"
          echo "version=$CEF_VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build libcef_dll_wrapper
        shell: cmd
        run: |
          cd ${{ steps.cef.outputs.dir }}
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target libcef_dll_wrapper

      - name: Package
        shell: bash
        run: |
          CEF_DIR="${{ steps.cef.outputs.dir }}"
          VERSION="${{ steps.cef.outputs.version }}"
          OUT="libcef-${VERSION}-windows-x64"
          mkdir -p "$OUT/lib"

          # Headers
          cp -r "$CEF_DIR/include" "$OUT/"

          # Libraries
          cp "$CEF_DIR/build/libcef_dll_wrapper/Release/libcef_dll_wrapper.lib" "$OUT/lib/" || \
          cp "$CEF_DIR/build/libcef_dll_wrapper/libcef_dll_wrapper.lib" "$OUT/lib/"
          cp "$CEF_DIR/Release/libcef.lib" "$OUT/lib/"
          cp "$CEF_DIR/Release/libcef.dll" "$OUT/lib/"

          # Resources
          cp "$CEF_DIR/Release/"*.bin "$OUT/lib/" || true
          cp "$CEF_DIR/Release/"*.dat "$OUT/lib/" || true
          cp "$CEF_DIR/Release/"*.pak "$OUT/lib/" || true
          cp -r "$CEF_DIR/Release/locales" "$OUT/lib/" || true
          cp "$CEF_DIR/LICENSE.txt" "$OUT/" || true

          7z a "${OUT}.zip" "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: libcef-*-windows-x64.zip

  build-macos-arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: brew install cmake ninja

      - name: Download CEF
        run: python3 scripts/download_cef.py --platform macosarm64 --output-dir cef_download

      - name: Get CEF version
        id: cef
        run: |
          CEF_DIR=$(ls -d cef_download/cef_binary_* | head -1)
          CEF_VERSION=$(cat cef_download/CEF_VERSION)
          echo "dir=$CEF_DIR" >> "$GITHUB_OUTPUT"
          echo "version=$CEF_VERSION" >> "$GITHUB_OUTPUT"

      - name: Build libcef_dll_wrapper
        run: |
          cd "${{ steps.cef.outputs.dir }}"
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target libcef_dll_wrapper -- -j2

      - name: Package
        run: |
          CEF_DIR="${{ steps.cef.outputs.dir }}"
          VERSION="${{ steps.cef.outputs.version }}"
          OUT="libcef-${VERSION}-macos-arm64"
          mkdir -p "$OUT/lib"

          # Headers
          cp -r "$CEF_DIR/include" "$OUT/"

          # Libraries
          cp "$CEF_DIR/build/libcef_dll_wrapper/libcef_dll_wrapper.a" "$OUT/lib/"
          cp -r "$CEF_DIR/Release/Chromium Embedded Framework.framework" "$OUT/lib/"

          cp "$CEF_DIR/LICENSE.txt" "$OUT/" || true

          tar -czvf "${OUT}.tar.gz" "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: libcef-*-macos-arm64.tar.gz

  build-macos-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: brew install cmake ninja

      - name: Download CEF
        run: python3 scripts/download_cef.py --platform macosx64 --output-dir cef_download

      - name: Get CEF version
        id: cef
        run: |
          CEF_DIR=$(ls -d cef_download/cef_binary_* | head -1)
          CEF_VERSION=$(cat cef_download/CEF_VERSION)
          echo "dir=$CEF_DIR" >> "$GITHUB_OUTPUT"
          echo "version=$CEF_VERSION" >> "$GITHUB_OUTPUT"

      - name: Build libcef_dll_wrapper
        run: |
          cd "${{ steps.cef.outputs.dir }}"
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build --target libcef_dll_wrapper -- -j2

      - name: Package
        run: |
          CEF_DIR="${{ steps.cef.outputs.dir }}"
          VERSION="${{ steps.cef.outputs.version }}"
          OUT="libcef-${VERSION}-macos-x86_64"
          mkdir -p "$OUT/lib"

          # Headers
          cp -r "$CEF_DIR/include" "$OUT/"

          # Libraries
          cp "$CEF_DIR/build/libcef_dll_wrapper/libcef_dll_wrapper.a" "$OUT/lib/"
          cp -r "$CEF_DIR/Release/Chromium Embedded Framework.framework" "$OUT/lib/"

          cp "$CEF_DIR/LICENSE.txt" "$OUT/" || true

          tar -czvf "${OUT}.tar.gz" "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: libcef-*-macos-x86_64.tar.gz

  release:
    needs: [build-windows, build-macos-arm64, build-macos-x64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from artifact name
        id: version
        run: |
          FILE=$(ls artifacts/windows-x64/*.zip | head -1)
          VERSION=$(basename "$FILE" | sed 's/libcef-\(.*\)-windows-x64.zip/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cef-${{ steps.version.outputs.version }}
          name: CEF ${{ steps.version.outputs.version }}
          body: |
            Prebuilt CEF (Chromium Embedded Framework) binaries.

            ## Platforms
            - Windows x64
            - macOS arm64
            - macOS x86_64

            ## Usage
            Extract and set `EXTERNAL_CEF_DIR` to the extracted path when building jellyfin-desktop-cef.
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
